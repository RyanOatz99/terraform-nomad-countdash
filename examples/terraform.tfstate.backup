{
  "version": 4,
  "terraform_version": "1.1.0",
  "serial": 3,
  "lineage": "e48e19fa-73d7-f816-6f6a-5daa12dd1ebc",
  "outputs": {},
  "resources": [
    {
      "module": "module.countdash",
      "mode": "managed",
      "type": "nomad_job",
      "name": "JOB",
      "provider": "provider[\"registry.terraform.io/hashicorp/nomad\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "allocation_ids": [
              "caa4577b-1015-d4e6-ccc0-40801be17b26",
              "6c07476c-0c18-3173-0a0a-b896159225aa",
              "c1e5cd0e-50a6-70e3-b579-61867cdbadd9"
            ],
            "datacenters": [
              "dc1"
            ],
            "deployment_id": null,
            "deployment_status": null,
            "deregister_on_destroy": true,
            "deregister_on_id_change": true,
            "detach": true,
            "hcl2": [
              {
                "allow_fs": false,
                "enabled": true,
                "vars": {}
              }
            ],
            "id": "dash-demo",
            "jobspec": "# ===============================================\n# NOMAD JOB\n# ===============================================\n\njob \"dash-demo\" {\n  datacenters = local.datacenters\n  namespace = local.namespace\n\n# -----------------------------------------------\n# START OF API TASK\n# -----------------------------------------------\n\n  group \"api\" {\n    count = local.api_count\n\n    network {\n       mode = \"bridge\"\n    }\n\n    service {\n      name = \"count-api\"\n      port = local.api_port\n      connect {\n        sidecar_task {\n          resources {\n            cpu = local.sidecar_cpu\n            memory = local.sidecar_ram\n          }\n        }\n        sidecar_service {}\n      }\n    }\n\n    task \"api\" {\n      driver = \"docker\"\n      \n      resources {\n        cpu    = local.api_cpu\n        memory = local.api_ram\n      }\n\n      config {\n        image = local.api_image\n      }\n    }\n  }\n\n# -----------------------------------------------\n# START OF DASHBOARD TASK\n# -----------------------------------------------\n\n  group \"dashboard\" {\n    count = local.dashboard_count\n\n    network {\n      mode =\"bridge\"\n      port \"http\" {\n        to = local.dashboard_port\n        static = 9000\n      }\n    }\n\n    service {\n      name = \"count-dashboard\"\n      port = local.dashboard_port\n      connect {\n        sidecar_task {\n          resources {\n            cpu = local.sidecar_cpu\n            memory = local.sidecar_ram\n          }\n        }\n        sidecar_service {\n          proxy {\n            upstreams {\n              destination_name = \"count-api\"\n              local_bind_port = 8080\n            }\n          }\n        }\n      }\n    }\n\n    task \"dashboard\" {\n      driver = \"docker\"\n\n      resources {\n        cpu    = local.dashboard_cpu\n        memory = local.dashboard_ram\n      }\n\n      env {\n        COUNTING_SERVICE_URL = \"http://${NOMAD_UPSTREAM_ADDR_count_api}\"\n      }\n\n      config {\n        image = local.dashboard_image\n      }\n    }\n  }\n}\n\n# ===============================================\n# TEMPLATE DEFAULTS \u0026 OVERRIDES\n# ===============================================\n\nlocals {\n  datacenters     = [\"dc1\"]\n  namespace       = \"default\"\n  \n  api_count       = 1\n  api_cpu         = 100\n  api_ram         = 32\n  api_image       = \"hashicorpnomad/counter-api:v3\"\n  api_port        = 9001\n  \n  dashboard_count = 1\n  dashboard_cpu     = 100\n  dashboard_ram     = 64\n  dashboard_image = \"hashicorpnomad/counter-dashboard:v3\"\n  dashboard_port  = 9002\n  \n  sidecar_cpu     = 100\n  sidecar_ram     = 64\n}\n\n",
            "json": null,
            "modify_index": "314941",
            "name": "dash-demo",
            "namespace": "default",
            "policy_override": null,
            "purge_on_destroy": null,
            "region": "global",
            "task_groups": [
              {
                "count": 1,
                "meta": {},
                "name": "api",
                "task": [
                  {
                    "driver": "docker",
                    "meta": {},
                    "name": "api",
                    "volume_mounts": []
                  },
                  {
                    "driver": "docker",
                    "meta": {},
                    "name": "connect-proxy-count-api",
                    "volume_mounts": []
                  }
                ],
                "volumes": []
              },
              {
                "count": 1,
                "meta": {},
                "name": "dashboard",
                "task": [
                  {
                    "driver": "docker",
                    "meta": {},
                    "name": "dashboard",
                    "volume_mounts": []
                  },
                  {
                    "driver": "docker",
                    "meta": {},
                    "name": "connect-proxy-count-dashboard",
                    "volume_mounts": []
                  }
                ],
                "volumes": []
              }
            ],
            "timeouts": null,
            "type": "service"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjozMDAwMDAwMDAwMDAsInVwZGF0ZSI6MzAwMDAwMDAwMDAwfX0="
        }
      ]
    }
  ]
}
